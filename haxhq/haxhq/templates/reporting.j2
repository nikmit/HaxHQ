{% extends 'layout.j2' %}

{% block body %}
  {% if active_engagement %}
  <h1>{{ active_engagement.org_name }}</h1>
    <div id='reportmenu'>
      <a id='hide_repmenu' href=''>Cancel</a>
      {% if eng_type != 'audit' %}
      <a class='linkmenu rounded' href='{{ url_for('add_issue') }}'>Add finding</a>
      {% endif %}
      {% if data %}
      <a class='linkmenu rounded' id='generate_report' href=''>Generate report</a>
        {% if eng_type != 'audit' %}
      <a class='linkmenu rounded optblock' href='{{ url_for('autoupdate_issues') }}'>Import library data</a>
        {% endif %}
      <a class='linkmenu rounded optblock' href='{{ url_for('export_xlsx') }}'>Export xlsx</a>
    <a class='linkmenu rounded optblock{% if rep_changed %} confirm'{% else %}'{% endif %} href='{{ url_for('summarise_findings', drop_existing=1) }}'>Drop and summarise again</a>
      {% endif %}
      <a id='reporting_burger' class='linkmenu rounded'>
        <img id='repburgerimg' src="{{ url_for('static', filename='img/burger-white.png') }}" width=30 height=17 alt='Reporting menu' />
      </a>
    </div>
      {% if summarised and eng_type != 'audit' %}
    <div id='report_by'>
      <p>Report will be generated by <span id='current_reportby'>hostname</span>.</p>
      <a id='reportby_link' href=''>Report by <span id='reportby_changeto'>IP address</span></a>
    </div>
      {% endif %}

  <div>
    {% if data %}
      {# issue listing #}
      {% for exposure in data|sort %}
        <h5>{{ exposure }}</h5>
    <form id='merge_{{ exposure }}' method='POST' action='{{ url_for('merge_issues', iid='') }}'>
      {{ form.csrf_token }}
      <table class='reporting_table'>
        <thead>
        <tr>
          <th class='rep-top-left'>severity</th>
          <th>title</th>
          <th class='text-center' style='width: max-content;'>
            <img src='{{ url_for('static', filename='img/checkmark.png') }}' alt='ready' />
            <p class='optinline'>ready</p>
          </th>
      {% if eng_type != 'audit' %}
          <th class='text-center' style='width: max-content; max-width: 200px;'>
            <img src='{{ url_for('static', filename='img/square.png') }}' alt='merge on'/>
            <p class='optinline'>merge on</p>
          </th>
          <th class='rep-top-right text-center' style='width: max-content; max-width: 200px;'>
            <img src='{{ url_for('static', filename='img/red_cross.png') }}' alt='merge' width='21px' height='20px' />
            <p class='optinline'>merge</p>
          </th>
      {% endif %}
        </tr>
        </thead>
        {% for severity in data[exposure]|sort|reverse %}
          {% for issue in data[exposure][severity] %}
        <tr class='hover rep_issue'>
          <td>
          {% if severity == 4 %}<p class='text-center Crit'>Critical</p>
          {% elif severity == 3 %}<p class='text-center High'>High</p>
          {% elif severity == 2 %}<p class='text-center Medium'>Medium</p>
          {% elif severity == 1 %}<p class='text-center Low'>Low</p>
          {% else %}<p class='text-center Info'>Info</p>
          {% endif %}
          </td>
          <td style='width: max-content;'><a href='{{ url_for('reporting', iid=issue.id) }}'>{{ issue.title }}</a></td>
          <td class='text-center'>
            {% if issue.ready %}<img src='{{url_for('static', filename='img/check_ok.png')}}' class='check_ok'>
            {% elif issue.autoupdated %}<img src='{{url_for('static', filename='img/check_auto_ok.png')}}' class='check_ok'>
            {% endif %}
          </td>
            {% if eng_type != 'audit' %}
          <td class="text-center"><input type='checkbox' class='merge_on' name='merge_on_{{ issue.id }}'></td>
          <td class="text-center"><input type='checkbox' class='merge' name='{{ issue.id }}'></td>
            {% endif %}
        </tr>
          {% endfor %}
        {% endfor %}
        {% if eng_type != 'audit' %}
        <tr>
          <td colspan=3></td>
          <td colspan=2>
            <input class="button green_btn merge_btn" type='submit' value='merge'>
          </td>
        </tr>
        {% endif %}
      </table>
    </form>
      {% endfor %}
    {% else %}
      <h3>Nothing to report on - please <a href='{{ url_for('hacking', hid='main') }}'>import scans</a> or add findings manually.</h3>
    {% endif %}
  </div>
  {% else %}
  <h1>No engagement to report on</h1>
  <h3><a href='{{ url_for('engagement') }}'>Please define/activate an engagement</a></h3>
  {% endif %}
{% endblock %}

