{% extends 'layout.j2' %}

{% block body %}

  <div>
    <h3 id='vuln_title' style='margin-top: 20px;'> {{ vuln.title }}</h3>
  {% if vuln.name and vuln.name != vuln.title %}
    <h4>{{ vuln.name }}</h4>
  {% endif %}
    <a href='{{ url_for('reporting', iid='all') }}' style='margin-right: 20px'>Back to list</a>
    <a href='{{ url_for('reporting', iid=vuln.iid) }}'>Back to issue</a>
    <p class='center' style='margin-bottom: 0;'>Affected services</p>
    <div id='affected_wrapper' style='width: fit-content; max-height: 400px; overflow: auto; text-align: center;' >
  {% for hoststr in vuln.affected %}
        <div class='affectedlist {% if vuln.exposure == 'external' %}external{% else %}internal{% endif %}'>
          {{ hoststr }}
        </div>
  {% endfor %}
    </div>
    <p style='margin: 20px 0 0;'>Merge candidates:</p>
    <form id='mergeform' method='POST' action = '{{url_for('merge_issues', iid=vuln.iid)}}'>
      {{ form.csrf_token }}
      <table class='reporting_table'>
        <tr>
          <th class='rep-top-left'>Severity</th>
          <th>Title</th>
          <th style='width: min-content; white-space: wrap;'>Additional services</th>
          <th style='width: min-content; white-space: wrap;'>Repeat services</th>
          <th class='rep-top-right'>Merge</th>
        </tr>
        {% for issue in merge_candidates %}
        <tr class='first_row rep_issue'>
          <td style='padding: 5px 0;'>
          {% if issue.severity == '4' %}<p class='Crit'>Critical</p>
          {% elif issue.severity == '3' %}<p class='High'>High</p>
          {% elif issue.severity == '2' %}<p class='Medium'>Medium</p>
          {% elif issue.severity == '1' %}<p class='Low'>Low</p>
          {% elif issue.severity == '0' %}<p class='Info'>Info</p>
          {% endif %}
          </td>
          <td>{{ issue.title }}</td>
          <td class='text-center' style='width: max-content;'>
            {% if issue.missing %}
                <span class='svc-num'>{{ issue.missing|length }}</span>
                {% for service in issue.missing %}
                  <p class='svc-detail'>{{ service }}</p>
                {% endfor %}
            {% else %}
                <span class='green'>none</span>
            {% endif %}
          </td>
          <td class='text-center' style='width: max-content;'>
            {% if not issue.repeat %}
                <span class='red'>none</span>
            {% elif issue.repeat|length == vuln.affected_count %}
                <span class='green'>all</span>
            {% else %}
                {{ issue.repeat|length }}/{{ vuln.affected_count }}
            {% endif %}
          </td>
          <td class="text-center"><input type='checkbox' class='merge' name='{{ issue.id }}'></td> 
        </tr>
        {% endfor %}
        <tr>
          <td colspan=5 style='text-align: right;'>
            <input class="button green_btn" type='submit' value='merge'>
          </td>
        </tr>
      </table>
    </form>
  </div>
{% endblock body %}

